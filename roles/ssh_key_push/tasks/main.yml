---
- name: Read local public key
  ansible.builtin.slurp:
    src: "{{ lookup('env', 'HOME') }}/.ssh/id_ed25519.pub"
  register: ssh_pubkey_raw
  delegate_to: localhost
  run_once: true

- name: Ensure .ssh directory exists for joshua
  ansible.builtin.file:
    path: /home/joshua/.ssh
    state: directory
    owner: joshua
    group: joshua
    mode: '0700'

- name: Add public key to authorized_keys
  ansible.builtin.authorized_key:
    user: joshua
    key: "{{ ssh_pubkey_raw.content | b64decode }}"
    state: present
