---
- name: Check if Portainer container exists and is running
  ansible.builtin.shell: |
    if docker ps --filter name=portainer --filter status=running --format "{{ '{{' }}.Names{{ '}}' }}" | grep -q portainer; then
      echo "running"
    elif docker ps -a --filter name=portainer --format "{{ '{{' }}.Names{{ '}}' }}" | grep -q portainer; then
      echo "exists"
    else
      echo "missing"
    fi
  register: portainer_status
  changed_when: false
  failed_when: false

- name: Check if Portainer data volume exists
  ansible.builtin.command: docker volume inspect {{ portainer_data_volume }}
  register: portainer_volume_check
  changed_when: false
  failed_when: false

- name: Create Portainer data volume
  ansible.builtin.command: docker volume create {{ portainer_data_volume }}
  register: vol_create
  changed_when: "'Created' in vol_create.stdout"
  failed_when: vol_create.rc != 0
  when: portainer_volume_check.rc != 0

- name: Start Portainer container if it exists but is not running
  ansible.builtin.command: docker start portainer
  register: container_start
  changed_when: container_start.rc == 0
  failed_when: container_start.rc != 0
  when: portainer_status.stdout == "exists"

- name: Run Portainer server container (only if missing)
  ansible.builtin.command: >
    docker run -d
    --name portainer
    --restart=always
    -p {{ portainer_https_port }}:9443
    -p {{ portainer_http_port }}:9000
    -v /var/run/docker.sock:/var/run/docker.sock
    -v {{ portainer_data_volume }}:/data
    {{ portainer_image }}
  register: container_run
  changed_when: container_run.rc == 0
  failed_when: container_run.rc != 0
  when: portainer_status.stdout == "missing"
