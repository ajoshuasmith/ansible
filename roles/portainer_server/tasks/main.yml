---
- name: Create Portainer data volume
  ansible.builtin.command: "docker volume create {{ portainer_data_volume }}"
  register: vol
  changed_when: "'Created' in vol.stdout"
  failed_when: vol.rc not in [0]

- name: Run Portainer server container
  ansible.builtin.command: >
    docker run -d
    --name portainer
    --restart=always
    -p {{ portainer_https_port }}:9443
    -p {{ portainer_http_port }}:9000
    -v /var/run/docker.sock:/var/run/docker.sock
    -v {{ portainer_data_volume }}:/data
    {{ portainer_image }}
  register: run
  changed_when: "'Unable to find image' in run.stderr or run.rc == 0"
  failed_when: run.rc not in [0,125]

- name: Ensure container is started
  ansible.builtin.command: docker start portainer
  ignore_errors: yes
